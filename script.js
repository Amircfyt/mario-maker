// Data

nameMap = {
  "games": {
    "smb": "Super Mario Bros.",
    "smb3": "Super Mario Bros. 3",
    "smw": "Super Mario World",
    "smbu": "New Super Mario Bros. U",
    "sm3d": "Super Mario 3D World"
  },
  "types": {
    "terrain": "Terrain",
    "items": "Items",
    "enemies": "Enemies",
    "gizmos": "Gizmos"
  },
  "terrain": {
    "block": "Block",
    "bridge": "Bridge",
    "clear_pipe": "Clear Pipe",
    "cloud_block": "Cloud Block",
    "donut_block": "Donut Block",
    "gentle_slope": "Gentle Slope",
    "ground": "Ground",
    "hard_block": "Hard Block",
    "hidden_block": "Hidden Block",
    "ice_block": "Ice Block",
    "mushroom_platform": "Mushroom Platform",
    "note_block": "Note Block",
    "pipe": "Pipe",
    "question_block": "? Block",
    "semisolid_platform": "Semisolid Platform",
    "spike_block": "Spike Block",
    "spike_trap": "Spike Trap",
    "steep_slope": "Steep Slope"
  },
  "items": {
    "big_mushroom": "Big Mushroom",
    "cape_feather": "Cape Feather",
    "coin": "Coin",
    "fifty_coin": "50-Coin",
    "fire_flower": "Fire Flower",
    "one_up_mushroom": "1-Up Mushroom",
    "pink_coin": "Pink Coin",
    "propeller_mushroom": "Propeller Mushroom",
    "rotten_mushroom": "Rotten Mushroom",
    "shoe_goomba": "Shoe Goomba",
    "stiletto_goomba": "Stiletto Goomba",
    "super_bell": "Super Bell",
    "super_hammer": "Super Hammer",
    "super_leaf": "Super Leaf",
    "super_mushroom": "Super Mushroom",
    "super_star": "Super Star",
    "superball_flower": "Superball Flower",
    "ten_coin": "10-Coin",
    "thirty_coin": "30-Coin",
    "yoshis_egg": "Yoshi's Egg"
  },
  "enemies": {
    "angry_sun": "Angry Sun",
    "angry_wiggler": "Angry Wiggler",
    "ant_trooper": "Ant Trooper",
    "blooper": "Blooper",
    "blooper_nanny": "Blooper Nanny",
    "bob_omb": "Bob-omb",
    "boo": "Boo",
    "boo_buddies": "Boo Buddies",
    "boom_boom": "Boom Boom",
    "bowser": "Bowser",
    "bowser_jr": "Bowser Jr.",
    "bully": "Bully",
    "buzzy_beetle": "Buzzy Beetle",
    "buzzy_beetle_shell": "Buzzy Beetle Shell",
    "chain_chomp": "Chain Chomp",
    "charvaargh": "Charvaargh",
    "cheep_cheep": "Cheep Cheep",
    "dry_bones": "Dry Bones",
    "dry_bones_shell": "Dry Bones Shell",
    "fire_bro": "Fire Bro",
    "fire_koopa_clown_car": "Fire Koopa Clown Car",
    "fire_piranha_plant": "Fire Piranha Plant",
    "fish_bone": "Fish Bone",
    "galoomba": "Galoomba",
    "goomba": "Goomba",
    "goombrat": "Goombrat",
    "goombud": "Goombud",
    "hammer_bro": "Hammer Bro",
    "hop_chops": "Hop-Chops",
    "horned_ant_trooper": "Horned Ant Trooper",
    "jumping_piranha_plant": "Jumping Piranha Plant",
    "koopa_clown_car": "Koopa Clown Car",
    "koopa_troopa": "Koopa Troopa",
    "koopa_troopa_car": "Koopa Troopa Car",
    "lakitu": "Lakitu",
    "lakitus_cloud": "Lakitu's Cloud",
    "lava_bubble": "Lava Bubble",
    "lit_bob_omb": "Lit Bob-omb",
    "magikoopa": "Magikoopa",
    "meowser": "Meowser",
    "monty_mole": "Monty Mole",
    "moon": "Moon",
    "muncher": "Muncher",
    "peepa": "Peepa",
    "piranha_creeper": "Piranha Creeper",
    "piranha_plant": "Piranha Plant",
    "pom_pom": "Pom Pom",
    "porcupuffer": "Porcupuffer",
    "rocky_wrench": "Rocky Wrench",
    "skipsqueak": "Skipsqueak",
    "spike_top": "Spike Top",
    "spiny": "Spiny",
    "spiny_shell": "Spiny Shell",
    "spiny_skipsqueak": "Spiny Skipsqueak",
    "stingby": "Stingby",
    "thwomp": "Thwomp",
    "unchained_chomp": "Unchained Chomp",
    "wiggler": "Wiggler"
  },
  "gizmos": {
    "arrow_sign": "Arrow Sign",
    "banzai_bill": "Banzai Bill",
    "bill_blaster": "Bill Blaster",
    "blinking_block": "Blinking Block",
    "bulls_eye_banzai": "Bull's-Eye Banzai",
    "bulls_eye_blaster": "Bull's-Eye Blaster",
    "bumper": "Bumper",
    "burner": "Burner",
    "cannon": "Cannon",
    "checkpoint_flag": "Checkpoint Flag",
    "cloud_lift": "Cloud Lift",
    "conveyor_belt": "Conveyor Belt",
    "crate": "Crate",
    "dotted_line_block": "Dotted-Line Block",
    "exclamation_block": "! Block",
    "fast_conveyor_belt": "Fast Conveyor Belt",
    "fast_lava_lift": "Fast Lava Lift",
    "fast_snake_block": "Fast Snake Block",
    "fire_bar": "Fire Bar",
    "flimsy_lift": "Flimsy Lift",
    "grinder": "Grinder",
    "icicle": "Icicle",
    "key": "Key",
    "key_door": "Key Door",
    "lava_lift": "Lava Lift",
    "lift": "Lift",
    "mushroom_trampoline": "Mushroom Trampoline",
    "on_off_switch": "ON/OFF Switch",
    "one_way_wall": "One-Way Wall",
    "p_switch": "P Switch",
    "p_warp_door": "P Warp Door",
    "pow_block": "POW Block",
    "red_cannon": "Red Cannon",
    "red_pow_block": "Red POW Block",
    "seesaw": "Seesaw",
    "skewer": "Skewer",
    "snake_block": "Snake Block",
    "swinging_claw": "Swinging Claw",
    "track": "Track",
    "track_block": "Track Block",
    "trampoline": "Trampoline",
    "tree": "Tree",
    "twister": "Twister",
    "vine": "Vine",
    "warp_box": "Warp Box",
    "warp_box_with_key": "Warp Box With Key",
    "warp_door": "Warp Door"
  }
}

gameObjects = {
  "smb": {
    "terrain": ["ground", "steep_slope", "gentle_slope", "pipe", "spike_trap", "mushroom_platform", "semisolid_platform", "bridge", "block", "question_block", "hard_block", "hidden_block", "donut_block", "note_block", "cloud_block", "ice_block"],
    "items": ["coin", "ten_coin", "pink_coin", "super_mushroom", "fire_flower", "big_mushroom", "super_star", "one_up_mushroom", "shoe_goomba"],
    "enemies": ["goomba", "koopa_troopa", "buzzy_beetle", "spike_top", "spiny", "blooper", "cheep_cheep", "piranha_plant", "muncher", "thwomp", "monty_mole", "rocky_wrench", "hammer_bro", "chain_chomp", "wiggler", "boo", "lava_bubble", "bob_omb", "dry_bones", "fish_bone", "magikoopa", "bowser", "bowser_jr", "boom_boom", "angry_sun", "lakitu", "koopa_clown_car"],
    "gizmos": ["burner", "bill_blaster", "banzai_bill", "cannon", "icicle", "twister", "key", "warp_door", "p_switch", "pow_block", "trampoline", "vine", "arrow_sign", "checkpoint_flag", "lift", "lava_lift", "seesaw", "grinder", "bumper", "skewer", "swinging_claw", "on_off_switch", "dotted_line_block", "snake_block", "fire_bar", "one_way_wall", "conveyor_belt", "track"]
  },
  "smb3": {
    "terrain": ["ground", "steep_slope", "gentle_slope", "pipe", "spike_trap", "mushroom_platform", "semisolid_platform", "bridge", "block", "question_block", "hard_block", "hidden_block", "donut_block", "note_block", "cloud_block", "ice_block"],
    "items": ["coin", "ten_coin", "pink_coin", "super_mushroom", "fire_flower", "super_leaf", "super_star", "one_up_mushroom", "shoe_goomba"],
    "enemies": ["goomba", "koopa_troopa", "buzzy_beetle", "spike_top", "spiny", "blooper", "cheep_cheep", "piranha_plant", "muncher", "thwomp", "monty_mole", "rocky_wrench", "hammer_bro", "chain_chomp", "wiggler", "boo", "lava_bubble", "bob_omb", "dry_bones", "fish_bone", "magikoopa", "bowser", "bowser_jr", "boom_boom", "angry_sun", "lakitu", "koopa_clown_car"],
    "gizmos": ["burner", "bill_blaster", "banzai_bill", "cannon", "icicle", "twister", "key", "warp_door", "p_switch", "pow_block", "trampoline", "vine", "arrow_sign", "checkpoint_flag", "lift", "lava_lift", "seesaw", "grinder", "bumper", "skewer", "swinging_claw", "on_off_switch", "dotted_line_block", "snake_block", "fire_bar", "one_way_wall", "conveyor_belt", "track"]
  },
  "smw": {
    "terrain": ["ground", "steep_slope", "gentle_slope", "pipe", "spike_trap", "mushroom_platform", "semisolid_platform", "bridge", "block", "question_block", "hard_block", "hidden_block", "donut_block", "note_block", "cloud_block", "ice_block"],
    "items": ["coin", "ten_coin", "pink_coin", "super_mushroom", "fire_flower", "cape_feather", "super_star", "one_up_mushroom", "yoshis_egg"],
    "enemies": ["galoomba", "koopa_troopa", "buzzy_beetle", "spike_top", "spiny", "blooper", "cheep_cheep", "jumping_piranha_plant", "muncher", "thwomp", "monty_mole", "rocky_wrench", "hammer_bro", "chain_chomp", "wiggler", "boo", "lava_bubble", "bob_omb", "dry_bones", "fish_bone", "magikoopa", "bowser", "bowser_jr", "boom_boom", "angry_sun", "lakitu", "koopa_clown_car"],
    "gizmos": ["burner", "bill_blaster", "banzai_bill", "cannon", "icicle", "twister", "key", "warp_door", "p_switch", "pow_block", "trampoline", "vine", "arrow_sign", "checkpoint_flag", "lift", "lava_lift", "seesaw", "grinder", "bumper", "skewer", "swinging_claw", "on_off_switch", "dotted_line_block", "snake_block", "fire_bar", "one_way_wall", "conveyor_belt", "track"]
  },
  "smbu": {
    "terrain": ["ground", "steep_slope", "gentle_slope", "pipe", "spike_trap", "mushroom_platform", "semisolid_platform", "bridge", "block", "question_block", "hard_block", "hidden_block", "donut_block", "note_block", "cloud_block", "ice_block"],
    "items": ["coin", "ten_coin", "pink_coin", "super_mushroom", "fire_flower", "propeller_mushroom", "super_star", "one_up_mushroom", "yoshis_egg"],
    "enemies": ["goomba", "koopa_troopa", "buzzy_beetle", "spike_top", "spiny", "blooper", "cheep_cheep", "piranha_plant", "muncher", "thwomp", "monty_mole", "rocky_wrench", "hammer_bro", "chain_chomp", "wiggler", "boo", "lava_bubble", "bob_omb", "dry_bones", "fish_bone", "magikoopa", "bowser", "bowser_jr", "boom_boom", "angry_sun", "lakitu", "koopa_clown_car"],
    "gizmos": ["burner", "bill_blaster", "banzai_bill", "cannon", "icicle", "twister", "key", "warp_door", "p_switch", "pow_block", "trampoline", "vine", "arrow_sign", "checkpoint_flag", "lift", "lava_lift", "seesaw", "grinder", "bumper", "skewer", "swinging_claw", "on_off_switch", "dotted_line_block", "snake_block", "fire_bar", "one_way_wall", "conveyor_belt", "track"]
  },
  "sm3d": {
    "terrain": ["ground", "steep_slope", "gentle_slope", "pipe", "clear_pipe", "spike_block", "semisolid_platform", "block", "question_block", "hard_block", "hidden_block", "donut_block", "cloud_block", "ice_block"],
    "items": ["coin", "ten_coin", "pink_coin", "super_mushroom", "super_bell", "super_hammer", "fire_flower", "super_star", "one_up_mushroom"],
    "enemies": ["goomba", "koopa_troopa", "ant_trooper", "spiny", "blooper", "cheep_cheep", "skipsqueak", "stingby", "piranha_plant", "piranha_creeper", "thwomp", "hammer_bro", "hop_chops", "boo", "lava_bubble", "bob_omb", "dry_bones", "fish_bone", "magikoopa", "meowser", "boom_boom", "charvaargh", "bully", "porcupuffer", "koopa_troopa_car"],
    "gizmos": ["bill_blaster", "banzai_bill", "icicle", "twister", "on_off_switch", "conveyor_belt", "crate", "key", "warp_door", "warp_box", "p_switch", "pow_block", "trampoline", "arrow_sign", "checkpoint_flag", "cloud_lift", "exclamation_block", "snake_block", "blinking_block", "track_block", "tree", "mushroom_trampoline"]
  }
}

// Data Methods

const makeObject = function ({gameKey, typeKey, index, locked = false}) {
  const objectKey = gameObjects[gameKey][typeKey][index]
  return {
    gameKey,
    typeKey,
    objectKey,
    index,
    locked,
    name: nameMap[typeKey][objectKey],
    image: `./assets/${gameKey}/${typeKey}/${objectKey}.png`
  }
}

const makeRandomObject = function (gameKey, typeKey) {
  if (!typeKey) {
    let typeKeys = Object.keys(nameMap.types)
    typeKey = typeKeys[Math.floor(Math.random()*typeKeys.length)]
  }
  let typeObjectList = gameObjects[gameKey][typeKey]
  let objectIndex = Math.floor(Math.random()*typeObjectList.length)
  return makeObject({gameKey, typeKey, index: objectIndex})
}

// Render Methods

const createGameButton = function (gameKey) {
  let container = document.createElement('div')
  container.innerHTML = `
    <div class="Box Box_big Box_rect">
      <div class="Box-Container">
        <div class="Box-Content">
          <img class="Box-Image" src="./assets/${gameKey}/logo.png" draggable="false">
        </div>
      </div>
    </div>
  `
  return container.firstElementChild
}

const createTypeButton = function (typeKey) {
  let container = document.createElement('div')
  container.innerHTML = `
    <div class="Box Box_circle Box_big">
      <div class="Box-Content">
        <img class="Box-Image" src="./assets/${typeKey}.png" draggable="false">
      </div>
    </div>
  `
  return container.firstElementChild
}

const createObjectButton = function (object) {
  let lockedClass = object.locked ? "Box_locked " : ""
  let container = document.createElement('div')
  container.innerHTML = `
    <div class="Box ${lockedClass}Box_${object.typeKey}">
      <div class="Box-Cap"></div>
      <div class="Box-Color"></div>
      <div class="Box-Container">
        <div class="Box-Content Box-Content_border">
          <img class="Box-Image" src="${object.image}" draggable="false">
        </div>
      </div>
    </div>
  `
  return container.firstElementChild
}

const createRerollButton = function (typeKey) {
  let container = document.createElement('div')
  container.innerHTML = `
    <div class="Box Box_${typeKey}">
      <div class="Box-Cap"></div>
      <div class="Box-Color"></div>
      <div class="Box-Container">
        <div class="Box-Content Box-Content_border">
          ?
        </div>
      </div>
    </div>
  `
  return container.firstElementChild
}

const createPreloadLink = function (object) {
  let container = document.createElement('div')
  container.innerHTML = `
      <link rel="preload" href="${object.image}" as="image" type="image/png">
  `
  return container.firstElementChild
}

// Element Mutators

const exposeButton = function (button, delay = 0) {
  button.classList.add('Box_hidden')
  setTimeout(() => {
    button.classList.remove('Box_hidden')
  }, 10*(delay+1))
}

const exposeButtonList = function (buttonList, offset = 0) {
  for (let index = 0; index < buttonList.length; index++) {
    exposeButton(buttonList[index], index + offset)
  }
}

// Refresh Methods

const updateGameButton = function (state) {
  let gameButton = document.getElementById('game_button')
  let gameImage = gameButton.querySelector('img')
  gameImage.src = `./assets/${state.activeGameKey}/logo.png`
}

let disableClick = false

const updateObjects = function (state) {
  let objectToolbar = document.getElementById('object_toolbar')
  let boxList = Array.prototype.slice.apply(objectToolbar.querySelectorAll('.Box'))
  let objectList = state.objectList
  const handleObjectButton = function (object) {
    return (event) => {
      if (disableClick !== true) {
        if (state.activeObject !== object) {
          state.activeObject = object
          updateObjects(state)
          setTypeSelectors(state)
        } else {
          state.activeObject = null
          updateObjects(state)
          clearSelectors(state)
        }
      }
    }
  }
  const handleLongPress = function (object) {
    return (event) => {
      if (event.target === event.currentTarget) {
        object.locked = !object.locked
        if (object.locked) {
          event.target.classList.add('Box_locked')
        } else {
          event.target.classList.remove('Box_locked')
        }
        disableClick = true
      }
    }
  }
  for (let index = 0; index < boxList.length; index++) {
    let box = boxList[index]
    let object = objectList[index]
    let newBox = createObjectButton(object)
    if (object === state.activeObject) {
      newBox.classList.add('Box_selected')
    }
    newBox.classList.add('Box_animated')
    objectToolbar.replaceChild(newBox, box)
    newBox.addEventListener('click', handleObjectButton(objectList[index]))
    newBox.addEventListener('animationend', handleLongPress(objectList[index]));
  }
}

const clearSelectors = function (state) {
  let main = document.getElementById('main')
  let previousContent = main.querySelector('.Main-Content')
  previousContent ? main.removeChild(previousContent) : null
}

const setGameSelectors = function (state) {
  let main = document.getElementById('main')
  // Create Elements
  let smbButton = createGameButton('smb')
  let smb3Button = createGameButton('smb3')
  let smwButton = createGameButton('smw')
  let smbuButton = createGameButton('smbu')
  let sm3dButton = createGameButton('sm3d')
  let container = document.createElement('div')
  container.innerHTML = `
    <div class="Main-Content">
    </div>
  `
  let content = container.querySelector('.Main-Content')
  content.appendChild(smbButton)
  content.appendChild(smb3Button)
  content.appendChild(smwButton)
  content.appendChild(smbuButton)
  content.appendChild(sm3dButton)
  // Set Interactivity
  clearSelectors(state)
  main.appendChild(content)
  exposeButtonList([smbButton, smb3Button, smwButton, smbuButton, sm3dButton])
  const handleGameButton = function (gameKey) {
    return (event) => {
      state.activeGameKey = gameKey
      updateGameButton(state)
      updateObjects(state)
      clearSelectors(state)
    }
  }
  smbButton.addEventListener('click', handleGameButton('smb'))
  smb3Button.addEventListener('click', handleGameButton('smb3'))
  smwButton.addEventListener('click', handleGameButton('smw'))
  smbuButton.addEventListener('click', handleGameButton('smbu'))
  sm3dButton.addEventListener('click', handleGameButton('sm3d'))
}

const setTypeSelectors = function (state) {
  let main = document.getElementById('main')
  // Create Elements
  let terrainButton = createTypeButton('terrain')
  let itemsButton = createTypeButton('items')
  let enemiesButton = createTypeButton('enemies')
  let gizmosButton = createTypeButton('gizmos')
  let container = document.createElement('div')
  container.innerHTML = `
    <div class="Main-Content">
    </div>
  `
  let content = container.querySelector('.Main-Content')
  content.appendChild(terrainButton)
  content.appendChild(itemsButton)
  content.appendChild(enemiesButton)
  content.appendChild(gizmosButton)
  // Set Interactivity
  clearSelectors(state)
  main.appendChild(content)
  exposeButtonList([terrainButton, itemsButton, enemiesButton, gizmosButton])
  const handleTypeButton = function (typeKey) {
    return (event) => {
      setObjectSelectors(state, typeKey)
    }
  }
  terrainButton.addEventListener('click', handleTypeButton('terrain'))
  itemsButton.addEventListener('click', handleTypeButton('items'))
  enemiesButton.addEventListener('click', handleTypeButton('enemies'))
  gizmosButton.addEventListener('click', handleTypeButton('gizmos'))
}

const setObjectSelectors = function (state, typeKey) {
  let main = document.getElementById('main')
  // Create Elements
  let objectKeys = gameObjects[state.activeGameKey][typeKey]
  let objectList = objectKeys.map((objectKey, index) => makeObject({gameKey: state.activeGameKey, typeKey, index}))
  let objectButtons = objectList.map((object) => createObjectButton(object))
  let rerollButton = createRerollButton(typeKey)
  let container = document.createElement('div')
  container.innerHTML = `
    <div class="Main-Content">
    </div>
  `
  let content = container.querySelector('.Main-Content')
  const handleObjectButton = function (object) {
    return (event) => {
      let index = state.objectList.indexOf(state.activeObject)
      let locked = state.activeObject.locked
      state.activeObject = null
      state.objectList[index] = object
      state.objectList[index].locked = locked
      updateObjects(state)
      clearSelectors(state)
    }
  }
  objectButtons.forEach((button, index) => {
    content.appendChild(button)
    button.addEventListener('click', handleObjectButton(objectList[index]))
  })
  content.appendChild(rerollButton)
  // Set Interactivity
  const handleRerollButton = function (event) {
      let index = state.objectList.indexOf(state.activeObject)
      let locked = state.activeObject.locked
      state.activeObject = null
      state.objectList[index] = makeRandomObject(state.activeGameKey, typeKey)
      state.objectList[index].locked = locked
      updateObjects(state)
      clearSelectors(state)
  }
  clearSelectors(state)
  main.appendChild(content)
  exposeButtonList([...objectButtons, rerollButton])
  rerollButton.addEventListener('click', handleRerollButton)
}

const setPreloadLinks = function (state) {
  let head = document.querySelector('head')
  for (let gameKey in gameObjects) {
    for (let typeKey in gameObjects[gameKey]) {
      for (let index = 0; index < gameObjects[gameKey][typeKey].length; index++) {
        let object = makeObject({gameKey, typeKey, index})
        let preloadLink = createPreloadLink(object)
        head.appendChild(preloadLink)
      }
    }
  }
}

const setSerializedUrl = function (state) {
  let serializedObjectsString = state.objectList.map((object) => `${object.typeKey[0]}${object.index}`).join(',')
  let serializedString = `g=${state.activeGameKey}&o=${serializedObjectsString}`
  location.hash = serializedString
  navigator.clipboard.writeText(location)
}

// Global State

class State {
  constructor () {
    this._activeGameKey = 'smbu'
    this.activeObject = null
    this.objectList = []
    this.shuffle()
  }
  get activeGameKey () {
    return this._activeGameKey
  }
  set activeGameKey (gameKey) {
    if (Object.keys(nameMap.games).indexOf(gameKey) === -1) {
      throw new Error('State Error: Invalid Game Key')
    }
    if (this._activeGameKey !== gameKey) {
      let previousGameKey = this._activeGameKey
      this._activeGameKey = gameKey
      if (gameKey === 'sm3d' || previousGameKey === 'sm3d') {
        this.objectList = []
        this.shuffle()
      } else {
        for (let index = 0; index < this.objectList.length; index++) {
          let object = this.objectList[index]
          object.gameKey = this.activeGameKey
          this.objectList[index] = makeObject(object)
        }
      }
    }
  }
  parseSerializedState (stateString) {
    try {
      let attributes = stateString.split('&')
      for (let index = 0; index < attributes.length; index++) {
        let key = attributes[index].split('=')[0]
        let value = attributes[index].split('=')[1]
        switch (key) {
          case 'g':
            this.activeGameKey = value
            break;
          case 'o':
            this.objectList = value.split(',').map((value) => {
              let matches = value.match(/([a-z])([0-9]+)/)
              let typeKey = ({'t': 'terrain', 'i': 'items', 'e': 'enemies', 'g': 'gizmos'})[matches[1]]
              let index = parseInt(matches[2])
              return makeObject({gameKey: this.activeGameKey, typeKey, index, locked: true})
            })
            break;
        }
      }
    } catch (error) {
      console.error(error)
    }
  }
  shuffle () {
    let newObjectList = []
    for (let index = 0; index < 12; index++) {
      let object = this.objectList[index]
      if (object && !object.locked) {
        this.objectList[index] = {}
      }
    }
    for (let index = 0; index < 12; index++) {
      while(!this.objectList[index] || !this.objectList[index].image) {
        let newObject = makeRandomObject(this.activeGameKey)
        if (!this.objectList.find((findObject) => findObject.image === newObject.image)) {
          this.objectList[index] = newObject
        }
      }
    }
    return this
  }
}

// Global Management

window.addEventListener('DOMContentLoaded', (event) => {
  let startTime = Date.now()
  window.oncontextmenu = (event) => {
     event.preventDefault();
     event.stopPropagation();
     return false;
  }
  window.addEventListener('beforeunload', function() {
    gtag('event', 'time_on_site', {
      'event_category': 'lifecycle',
      'value': Date.now() - startTime
    });
  });
  let state = new State()
  state.parseSerializedState(location.hash.replace('#', ''))
  setPreloadLinks(state)
  updateGameButton(state)
  updateObjects(state)
  let boxList = Array.prototype.slice.apply(document.body.querySelectorAll('.Box'))
  for (let index = 0; index < boxList.length; index++) {
    let box = boxList[index]
    box.classList.add('Box_hidden')
    exposeButton(box, index)
  }
  document.body.addEventListener('click', (event) => {disableClick = false})
  document.body.addEventListener('mouseout', (event) => {disableClick = false})
  document.querySelector('#save_button').addEventListener('click', (event) => {setSerializedUrl(state)})
  document.querySelector('#shuffle_button').addEventListener('click', (event) => {
    updateObjects(state.shuffle())
    clearSelectors(state)
  })
  document.querySelector('#game_button').addEventListener('click', (event) => {
    updateGameButton(state)
    setGameSelectors(state)
  })
})
